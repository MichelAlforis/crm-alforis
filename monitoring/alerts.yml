# ============================================
# PROMETHEUS ALERTING RULES - CRM TPM FINANCE
# ============================================
# Règles d'alerting pour détecter les problèmes critiques:
# - CPU élevé (>90% pendant 5min)
# - RAM élevée (>90% pendant 5min)
# - Disque plein (>85%)
# - API down (health check échoue)
# - Taux d'erreur élevé (>5% pendant 5min)
# - Requêtes lentes (p95 >2s)

groups:
  # ========================================
  # ALERTES SYSTÈME
  # ========================================
  - name: system_alerts
    interval: 30s
    rules:
      # CPU élevé
      - alert: HighCPUUsage
        expr: system_cpu_percent > 90
        for: 5m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "CPU usage critique (instance {{ $labels.instance }})"
          description: "CPU à {{ $value }}% pendant plus de 5 minutes"

      # CPU critique
      - alert: CriticalCPUUsage
        expr: system_cpu_percent > 95
        for: 2m
        labels:
          severity: critical
          service: system
        annotations:
          summary: "CPU usage CRITIQUE (instance {{ $labels.instance }})"
          description: "CPU à {{ $value }}% - risque de crash imminent"

      # RAM élevée
      - alert: HighMemoryUsage
        expr: system_memory_percent > 90
        for: 5m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "Memory usage élevé (instance {{ $labels.instance }})"
          description: "RAM à {{ $value }}% pendant plus de 5 minutes"

      # RAM critique
      - alert: CriticalMemoryUsage
        expr: system_memory_percent > 95
        for: 2m
        labels:
          severity: critical
          service: system
        annotations:
          summary: "Memory usage CRITIQUE (instance {{ $labels.instance }})"
          description: "RAM à {{ $value }}% - risque d'OOM imminent"

      # Disque plein
      - alert: DiskSpaceRunningOut
        expr: system_disk_percent > 85
        for: 10m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "Espace disque faible (instance {{ $labels.instance }})"
          description: "Disque à {{ $value }}% - nettoyage requis"

      # Disque critique
      - alert: DiskSpaceCritical
        expr: system_disk_percent > 95
        for: 5m
        labels:
          severity: critical
          service: system
        annotations:
          summary: "Espace disque CRITIQUE (instance {{ $labels.instance }})"
          description: "Disque à {{ $value }}% - action immédiate requise"

  # ========================================
  # ALERTES BASE DE DONNÉES
  # ========================================
  - name: database_alerts
    interval: 30s
    rules:
      # Trop de connexions actives
      - alert: HighDatabaseConnections
        expr: db_connections_active > 40
        for: 5m
        labels:
          severity: warning
          service: database
        annotations:
          summary: "Nombre élevé de connexions DB"
          description: "{{ $value }} connexions actives (limite: 50)"

      # Taux d'échec élevé des tâches
      - alert: HighTaskFailureRate
        expr: |
          (
            rate(tasks_failed_last_24h[5m]) /
            (rate(tasks_created_last_24h[5m]) + 0.001)
          ) > 0.1
        for: 5m
        labels:
          severity: warning
          service: application
        annotations:
          summary: "Taux d'échec des tâches élevé"
          description: "Plus de 10% des tâches échouent"

  # ========================================
  # ALERTES CACHE REDIS
  # ========================================
  - name: cache_alerts
    interval: 30s
    rules:
      # Cache hit rate faible
      - alert: LowCacheHitRate
        expr: |
          (
            cache_hits_total /
            (cache_hits_total + cache_misses_total + 0.001)
          ) < 0.5
        for: 10m
        labels:
          severity: info
          service: cache
        annotations:
          summary: "Cache hit rate faible"
          description: "Hit rate < 50% - optimisation possible"

      # Mémoire cache élevée
      - alert: HighCacheMemory
        expr: cache_memory_bytes > 500000000  # 500MB
        for: 5m
        labels:
          severity: info
          service: cache
        annotations:
          summary: "Cache Redis utilise beaucoup de mémoire"
          description: "{{ $value | humanize }}B utilisés"

  # ========================================
  # ALERTES MÉTIER
  # ========================================
  - name: business_alerts
    interval: 1m
    rules:
      # Pas d'activité utilisateur
      - alert: NoUserActivity
        expr: rate(interactions_created_last_24h[1h]) == 0
        for: 2h
        labels:
          severity: info
          service: application
        annotations:
          summary: "Aucune activité utilisateur détectée"
          description: "Pas de nouvelles interactions depuis 2 heures"

      # Emails bloqués
      - alert: EmailsSendingFailed
        expr: rate(emails_sent_total{status="failed"}[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          service: email
        annotations:
          summary: "Échec d'envoi d'emails"
          description: "{{ $value }} emails/s échouent"

  # ========================================
  # ALERTES DISPONIBILITÉ
  # ========================================
  - name: availability_alerts
    interval: 30s
    rules:
      # Service down
      - alert: ServiceDown
        expr: up{job="crm-api"} == 0
        for: 1m
        labels:
          severity: critical
          service: api
        annotations:
          summary: "CRM API est DOWN"
          description: "Le service {{ $labels.job }} est inaccessible"

      # Prometheus ne peut pas scraper
      - alert: PrometheusTargetDown
        expr: up == 0
        for: 2m
        labels:
          severity: warning
          service: monitoring
        annotations:
          summary: "Prometheus target down: {{ $labels.job }}"
          description: "Target {{ $labels.instance }} inaccessible"
