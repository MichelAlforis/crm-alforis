# üè¶ CRM TPM Finance - Application de Gestion du Pipeline d'Investissement

Application CRM full-stack pour la gestion des investisseurs et du pipeline commercial.

## üìã Table des Mati√®res

- [Technologies](#-technologies)
- [Pr√©requis](#-pr√©requis)
- [Installation Rapide](#-installation-rapide-avec-docker)
- [Configuration](#Ô∏è-configuration)
- [Utilisation](#-utilisation)
- [D√©veloppement](#-d√©veloppement)
- [Production](#-production)
- [Structure du Projet](#-structure-du-projet)
- [API Documentation](#-api-documentation)
- [D√©pannage](#-d√©pannage)

---

## üöÄ Technologies

### Backend
- **FastAPI** 0.104.1 - Framework web Python moderne
- **SQLAlchemy** 2.0.23 - ORM pour PostgreSQL
- **PostgreSQL** 16 - Base de donn√©es
- **JWT** - Authentification s√©curis√©e
- **Uvicorn** - Serveur ASGI

### Frontend
- **Next.js** 14.2.33 - Framework React
- **TypeScript** 5.3.0 - Typage statique
- **Tailwind CSS** 3.3.0 - Styling
- **Zustand** 4.4.0 - Gestion d'√©tat
- **React Hook Form** + **Zod** - Validation de formulaires
- **Recharts** - Graphiques et visualisations

### Infrastructure
- **Docker** + **Docker Compose** - Containerisation
- **PostgreSQL 16 Alpine** - Base de donn√©es en container

---

## üì¶ Pr√©requis

- **Docker** >= 20.10
- **Docker Compose** >= 2.0
- **(Optionnel)** Node.js 20+ et Python 3.11+ pour d√©veloppement local

---

## ‚ö° Installation Rapide avec Docker

### 1Ô∏è‚É£ Cloner le projet

```bash
cd /path/to/project
```

### 2Ô∏è‚É£ Cr√©er le fichier `.env`

```bash
cp .env.example .env
```

**√âditer `.env` et modifier au minimum :**

```env
# S√©curit√© - CHANGEZ CETTE VALEUR !
SECRET_KEY=VOTRE_CLE_SECRETE_FORTE

# Base de donn√©es
POSTGRES_PASSWORD=VOTRE_MOT_DE_PASSE_SECURISE
```

üí° **G√©n√©rer une cl√© secr√®te forte :**

```bash
openssl rand -hex 32
```

### 3Ô∏è‚É£ Lancer l'application

```bash
docker-compose up -d
```

**Attendez 1-2 minutes** que tous les services d√©marrent et passent les healthchecks.

### 4Ô∏è‚É£ V√©rifier le statut

```bash
docker-compose ps
```

Tous les services doivent √™tre `Up (healthy)` :

```
NAME            STATUS
crm-postgres    Up (healthy)
crm-api         Up (healthy)
crm-frontend    Up (healthy)
```

### 5Ô∏è‚É£ Acc√©der √† l'application

| Service | URL | Description |
|---------|-----|-------------|
| **Frontend** | http://localhost:3010 | Interface utilisateur |
| **API** | http://localhost:8000 | API REST |
| **API Docs** | http://localhost:8000/docs | Documentation Swagger |
| **PostgreSQL** | localhost:5433 | Base de donn√©es |

---

## ‚öôÔ∏è Configuration

### Variables d'Environnement

Toutes les variables sont dans [.env.example](.env.example). Principales variables :

#### Base de Donn√©es
```env
POSTGRES_USER=crm_user
POSTGRES_PASSWORD=votre_password
POSTGRES_DB=crm_db
POSTGRES_EXTERNAL_PORT=5433
```

#### Backend API
```env
DEBUG=True                    # False en production
SECRET_KEY=votre_cle_secrete
ALLOWED_ORIGINS=http://localhost:3010,http://localhost:3000
API_PORT=8000
```

#### Frontend
```env
NEXT_PUBLIC_API_URL=http://localhost:8000
FRONTEND_PORT=3010
```

#### S√©curit√© JWT
```env
JWT_ALGORITHM=HS256
JWT_EXPIRATION_HOURS=24
```

---

## üéÆ Utilisation

### Commandes Docker Compose

```bash
# D√©marrer tous les services
docker-compose up -d

# Voir les logs en temps r√©el
docker-compose logs -f

# Logs d'un service sp√©cifique
docker-compose logs -f api
docker-compose logs -f frontend

# Arr√™ter les services
docker-compose down

# Arr√™ter ET supprimer les volumes (‚ö†Ô∏è PERTE DE DONN√âES)
docker-compose down -v

# Reconstruire les images
docker-compose build

# Reconstruire ET red√©marrer
docker-compose up -d --build

# Red√©marrer un service sp√©cifique
docker-compose restart api
```

### Acc√®s √† la Base de Donn√©es

#### Depuis l'h√¥te
```bash
psql -h localhost -p 5433 -U crm_user -d crm_db
# Password: crm_password (ou votre .env)
```

#### Depuis un container
```bash
docker exec -it crm-postgres psql -U crm_user -d crm_db
```

### Ex√©cuter des Commandes dans les Containers

```bash
# Backend - Shell Python
docker exec -it crm-api python

# Backend - Migrations Alembic
docker exec -it crm-api alembic upgrade head

# Frontend - Shell Node
docker exec -it crm-frontend sh

# Frontend - Installer une d√©pendance
docker exec -it crm-frontend npm install package-name
```

---

## üíª D√©veloppement

### Mode D√©veloppement avec Docker

Le setup actuel est **optimis√© pour le d√©veloppement** :

‚úÖ **Hot-reload activ√©** sur backend et frontend
‚úÖ **Code synchronis√©** en temps r√©el via volumes
‚úÖ **Healthchecks** pour d√©tecter les probl√®mes
‚úÖ **Logs d√©taill√©s** pour le debugging

### D√©veloppement Local (Sans Docker)

#### Backend

```bash
cd crm-backend

# Cr√©er un environnement virtuel
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# Installer les d√©pendances
pip install -r requirements.txt

# Cr√©er .env.local
cp .env.local.example .env.local

# Lancer le serveur
uvicorn main:app --reload --port 8000
```

#### Frontend

```bash
cd crm-frontend

# Installer les d√©pendances
npm install

# Cr√©er .env.local
cp .env.local.example .env.local

# Lancer le serveur dev
npm run dev

# Ou avec nettoyage
npm run devc
```

### Tests

```bash
# Backend
cd crm-backend
pytest

# Frontend
cd crm-frontend
npm run test
npm run type-check
npm run lint
```

---

## üè≠ Production

### Build de Production

```bash
# Build des images de production
docker-compose -f docker-compose.prod.yml build

# Lancer en production
docker-compose -f docker-compose.prod.yml up -d
```

### Checklist Pr√©-Production

- [ ] Changer `SECRET_KEY` dans `.env`
- [ ] Mettre `DEBUG=False`
- [ ] Configurer des mots de passe forts
- [ ] Restreindre `ALLOWED_ORIGINS` aux domaines autoris√©s
- [ ] Activer HTTPS/SSL
- [ ] Configurer les backups PostgreSQL
- [ ] Mettre en place un reverse proxy (Nginx/Traefik)
- [ ] Configurer les logs persistants
- [ ] Mettre en place la surveillance (monitoring)

---

## üìÅ Structure du Projet

```
.
‚îú‚îÄ‚îÄ crm-backend/              # Backend FastAPI
‚îÇ   ‚îú‚îÄ‚îÄ main.py              # Point d'entr√©e
‚îÇ   ‚îú‚îÄ‚îÄ core/                # Configuration, DB, s√©curit√©
‚îÇ   ‚îú‚îÄ‚îÄ models/              # Mod√®les SQLAlchemy
‚îÇ   ‚îú‚îÄ‚îÄ schemas/             # Sch√©mas Pydantic
‚îÇ   ‚îú‚îÄ‚îÄ api/routes/          # Endpoints API
‚îÇ   ‚îú‚îÄ‚îÄ services/            # Logique m√©tier
‚îÇ   ‚îú‚îÄ‚îÄ uploads/             # Fichiers upload√©s
‚îÇ   ‚îú‚îÄ‚îÄ backups/             # Sauvegardes DB
‚îÇ   ‚îî‚îÄ‚îÄ Dockerfile
‚îÇ
‚îú‚îÄ‚îÄ crm-frontend/            # Frontend Next.js
‚îÇ   ‚îú‚îÄ‚îÄ app/                 # Pages Next.js 14
‚îÇ   ‚îú‚îÄ‚îÄ components/          # Composants React
‚îÇ   ‚îú‚îÄ‚îÄ hooks/               # Hooks personnalis√©s
‚îÇ   ‚îú‚îÄ‚îÄ lib/                 # Types, API client, utils
‚îÇ   ‚îú‚îÄ‚îÄ services/            # Services API
‚îÇ   ‚îú‚îÄ‚îÄ scripts/             # Scripts utilitaires
‚îÇ   ‚îî‚îÄ‚îÄ Dockerfile
‚îÇ
‚îú‚îÄ‚îÄ docker-compose.yml       # Configuration Docker
‚îú‚îÄ‚îÄ .env                     # Variables d'environnement (gitignored)
‚îú‚îÄ‚îÄ .env.example             # Template de configuration
‚îî‚îÄ‚îÄ README.md                # Ce fichier
```

---

## üìñ API Documentation

### Endpoints Principaux

| M√©thode | Endpoint | Description | Auth |
|---------|----------|-------------|------|
| `POST` | `/api/v1/auth/login` | Connexion utilisateur | ‚ùå |
| `GET` | `/api/v1/auth/me` | Profil utilisateur | ‚úÖ |
| `GET` | `/api/v1/investors` | Liste des investisseurs | ‚úÖ |
| `POST` | `/api/v1/investors` | Cr√©er un investisseur | ‚úÖ |
| `GET` | `/api/v1/investors/{id}` | D√©tails d'un investisseur | ‚úÖ |
| `PUT` | `/api/v1/investors/{id}` | Modifier un investisseur | ‚úÖ |
| `DELETE` | `/api/v1/investors/{id}` | Supprimer un investisseur | ‚úÖ |
| `GET` | `/api/v1/interactions` | Liste des interactions | ‚úÖ |
| `POST` | `/api/v1/interactions` | Logger une interaction | ‚úÖ |
| `GET` | `/api/v1/kpis` | Liste des KPIs | ‚úÖ |
| `POST` | `/api/v1/kpis` | Cr√©er un KPI | ‚úÖ |

### Documentation Interactive

- **Swagger UI** : http://localhost:8000/docs
- **ReDoc** : http://localhost:8000/redoc

### Authentification

L'API utilise **JWT Bearer Token** :

```bash
# 1. Connexion
curl -X POST http://localhost:8000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email": "user@example.com", "password": "password"}'

# R√©ponse
{
  "access_token": "eyJ0eXAiOiJKV1QiLCJhbGc...",
  "token_type": "bearer"
}

# 2. Utiliser le token
curl http://localhost:8000/api/v1/investors \
  -H "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGc..."
```

---

## üîß D√©pannage

### Probl√®me : Les containers ne d√©marrent pas

```bash
# V√©rifier les logs
docker-compose logs

# Rebuild complet
docker-compose down -v
docker-compose build --no-cache
docker-compose up -d
```

### Probl√®me : Frontend ne se connecte pas √† l'API

1. V√©rifier que l'API est accessible :
```bash
curl http://localhost:8000/health
```

2. V√©rifier `NEXT_PUBLIC_API_URL` dans `.env`

3. V√©rifier les CORS dans le backend (`ALLOWED_ORIGINS`)

### Probl√®me : Erreur de connexion PostgreSQL

```bash
# V√©rifier que PostgreSQL est healthy
docker-compose ps postgres

# V√©rifier les logs
docker-compose logs postgres

# Test de connexion
docker exec -it crm-postgres pg_isready -U crm_user
```

### Probl√®me : Port d√©j√† utilis√©

```bash
# Trouver le processus qui bloque le port
lsof -i :3010  # ou 8000, 5433

# Tuer le processus
kill -9 <PID>

# Ou changer le port dans .env
FRONTEND_PORT=3011
```

### Probl√®me : Hot-reload ne fonctionne pas

Le hot-reload fonctionne via les volumes Docker. Si les changements ne sont pas d√©tect√©s :

```bash
# Red√©marrer le service
docker-compose restart frontend
docker-compose restart api
```

### Nettoyer compl√®tement Docker

```bash
# ‚ö†Ô∏è ATTENTION : Supprime TOUTES les donn√©es !
docker-compose down -v
docker system prune -a --volumes
```

---

## üìä Mod√®le de Donn√©es

### Investor (Investisseur)
- `id`, `name`, `email`, `phone`, `website`, `company`
- `industry`, `pipeline_stage`, `client_type`
- Relations : `contacts[]`, `interactions[]`, `kpis[]`

### Contact
- `id`, `investor_id`, `name`, `email`, `phone`, `title`

### Interaction
- `id`, `investor_id`, `type`, `date`, `duration_minutes`
- `subject`, `notes`

### KPI (Key Performance Indicators)
- `id`, `investor_id`, `year`, `month`
- `rdv_count`, `pitchs`, `due_diligences`, `closings`
- `revenue`, `commission_rate`

---

## ü§ù Contribution

1. Cr√©er une branche feature
```bash
git checkout -b feature/nouvelle-fonctionnalite
```

2. Faire vos modifications

3. Tester
```bash
docker-compose up -d --build
```

4. Commit et push
```bash
git add .
git commit -m "feat: description de la fonctionnalit√©"
git push origin feature/nouvelle-fonctionnalite
```

---

## üìù License

Propri√©taire - TPM Finance ¬© 2024

---

## üìû Support

Pour toute question ou probl√®me :
- **Email** : support@tpmfinance.com
- **Documentation API** : http://localhost:8000/docs

---

**Fait avec ‚ù§Ô∏è par l'√©quipe TPM Finance**
