# ğŸ” CRM AUTH - GUIDE DE TEST COMPLET

## âœ… Authentification ImplÃ©mentÃ©e!

L'authentification JWT est maintenant complÃ¨tement intÃ©grÃ©e au CRM.

---

## ğŸš€ Quick Start

### 1. RedÃ©marrer le Backend

```bash
cd crm-backend
docker-compose restart api
```

### 2. AccÃ©dez Ã  la Documentation

```
http://localhost:8000/docs
```

Vous verrez maintenant les routes `/api/v1/auth/*` au-dessus des routes existantes.

---

## ğŸ§ª Test des Endpoints d'Auth

### Test dans Swagger UI (Facile âœ¨)

1. Allez Ã  http://localhost:8000/docs
2. Ouvrez `/api/v1/auth/login` â†’ "Try it out"
3. Entrez:
```json
{
  "email": "admin@tpmfinance.com",
  "password": "admin123"
}
```
4. Cliquez "Execute"
5. Vous recevez un `access_token`

---

## ğŸ“ Utilisateurs de Test

| Email | Password | RÃ´le |
|-------|----------|------|
| `admin@tpmfinance.com` | `admin123` | Admin |
| `user@tpmfinance.com` | `user123` | User |

---

## ğŸ”‘ Workflow Complet: Login â†’ AccÃ¨s API

### Ã‰tape 1: Login (Obtenir le Token)

```bash
curl -X POST http://localhost:8000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@tpmfinance.com","password":"admin123"}'
```

**RÃ©ponse:**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJhZG1pbkB0cG1maW5hbmNlLmNvbSIsImVtYWlsIjoiYWRtaW5AdHBtZmluYW5jZS5jb20iLCJpc19hZG1pbiI6dHJ1ZSwibmFtZSI6IkFkbWluaXN0cmF0b3IiLCJleHAiOjE3Mjk2MDk1NDd9.abc123...",
  "token_type": "bearer",
  "expires_in": 86400
}
```

**â­ Sauvegardez le token!**

### Ã‰tape 2: Utiliser le Token

```bash
# Sauvegarder le token dans une variable
TOKEN="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJhZG1pbkB0cG1maW5hbmNlLmNvbSIsImVtYWlsIjoiYWRtaW5AdHBtZmluYW5jZS5jb20iLCJpc19hZG1pbiI6dHJ1ZSwibmFtZSI6IkFkbWluaXN0cmF0b3IiLCJleHAiOjE3Mjk2MDk1NDd9.abc123..."

# Utiliser le token pour accÃ©der aux API protÃ©gÃ©es
curl -H "Authorization: Bearer $TOKEN" \
     http://localhost:8000/api/v1/investors

# Ou avec jq pour formater la rÃ©ponse
curl -s -H "Authorization: Bearer $TOKEN" \
     http://localhost:8000/api/v1/investors | jq .
```

### Ã‰tape 3: Voir Mes Infos

```bash
curl -H "Authorization: Bearer $TOKEN" \
     http://localhost:8000/api/v1/auth/me

# RÃ©ponse:
# {
#   "email": "admin@tpmfinance.com",
#   "is_admin": true
# }
```

### Ã‰tape 4: RafraÃ®chir le Token

```bash
curl -X POST -H "Authorization: Bearer $TOKEN" \
     http://localhost:8000/api/v1/auth/refresh

# Retourne un nouveau token
```

---

## ğŸ¯ Script Complet de Test

Sauvegardez ce script comme `test_auth.sh`:

```bash
#!/bin/bash

set -e

BASE_URL="http://localhost:8000/api/v1"

echo "==================================="
echo "  CRM AUTH - Test Script"
echo "==================================="
echo ""

# 1. Login
echo "1ï¸âƒ£  Login with admin..."
RESPONSE=$(curl -s -X POST $BASE_URL/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@tpmfinance.com","password":"admin123"}')

TOKEN=$(echo $RESPONSE | jq -r '.access_token')

if [ "$TOKEN" == "null" ]; then
  echo "âŒ Login failed!"
  echo "Response: $RESPONSE"
  exit 1
fi

echo "âœ… Got token: ${TOKEN:0:50}..."
echo ""

# 2. Get current user info
echo "2ï¸âƒ£  Get current user info..."
curl -s -H "Authorization: Bearer $TOKEN" \
     $BASE_URL/auth/me | jq .
echo ""

# 3. Create investor (protected route)
echo "3ï¸âƒ£  Create investor..."
INVESTOR=$(curl -s -X POST $BASE_URL/investors \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name":"Test Co","email":"test@example.com"}')

INVESTOR_ID=$(echo $INVESTOR | jq -r '.id')
echo "âœ… Created investor with ID: $INVESTOR_ID"
echo ""

# 4. List investors
echo "4ï¸âƒ£  List investors..."
curl -s -H "Authorization: Bearer $TOKEN" \
     $BASE_URL/investors | jq '.items[0]'
echo ""

# 5. Create interaction
echo "5ï¸âƒ£  Create interaction..."
curl -s -X POST -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"type":"appel","date":"2024-10-15"}' \
  $BASE_URL/interactions/investor/$INVESTOR_ID | jq .
echo ""

# 6. Refresh token
echo "6ï¸âƒ£  Refresh token..."
NEW_TOKEN=$(curl -s -X POST -H "Authorization: Bearer $TOKEN" \
  $BASE_URL/auth/refresh | jq -r '.access_token')

echo "âœ… Got new token: ${NEW_TOKEN:0:50}..."
echo ""

# 7. Test with new token
echo "7ï¸âƒ£  Test with new token..."
curl -s -H "Authorization: Bearer $NEW_TOKEN" \
     $BASE_URL/auth/me | jq .
echo ""

echo "==================================="
echo "âœ¨ All tests passed!"
echo "==================================="
```

**Utilisation:**
```bash
chmod +x test_auth.sh
./test_auth.sh
```

---

## ğŸš¨ Cas d'Erreur Ã  Tester

### âŒ Sans Token
```bash
curl http://localhost:8000/api/v1/investors
# RÃ©ponse: 401 Unauthorized - "Not authenticated"
```

### âŒ Token Invalide
```bash
curl -H "Authorization: Bearer invalid_token" \
     http://localhost:8000/api/v1/investors
# RÃ©ponse: 401 Unauthorized - "Token invalide ou expirÃ©"
```

### âŒ Mauvais Credentials
```bash
curl -X POST http://localhost:8000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@tpmfinance.com","password":"wrong"}'
# RÃ©ponse: 401 Unauthorized - "Email ou mot de passe incorrect"
```

### âŒ Token ExpirÃ©
```bash
# Attendre 24h (ou changer JWT_EXPIRATION_HOURS Ã  1 sec pour tester)
curl -H "Authorization: Bearer expired_token" \
     http://localhost:8000/api/v1/investors
# RÃ©ponse: 401 Unauthorized
```

---

## ğŸ“Š Routes d'Auth Disponibles

### POST /api/v1/auth/login
**Login et obtenir un token**
- Requiert: `email`, `password`
- Retourne: `access_token`, `token_type`, `expires_in`

### GET /api/v1/auth/me
**Obtenir les infos de l'utilisateur connectÃ©**
- Requiert: Header `Authorization: Bearer TOKEN`
- Retourne: `email`, `is_admin`

### POST /api/v1/auth/refresh
**RafraÃ®chir un token existant**
- Requiert: Header `Authorization: Bearer TOKEN`
- Retourne: Nouveau token avec mÃªme donnÃ©es

### POST /api/v1/auth/logout
**Logout (cÃ´tÃ© client: supprimer le token)**
- Pas de token requis
- Retourne: Message de confirmation

---

## ğŸ” Utilisation dans React (Phase 2)

```javascript
// 1. Login
const login = async (email, password) => {
  const res = await fetch('http://localhost:8000/api/v1/auth/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email, password })
  });
  
  const data = await res.json();
  const token = data.access_token;
  
  // Sauvegarder le token
  localStorage.setItem('token', token);
  return token;
};

// 2. Utiliser le token
const fetchInvestors = async (token) => {
  const res = await fetch('http://localhost:8000/api/v1/investors', {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  });
  
  return res.json();
};

// 3. Automatiser avec interceptor
const fetchWithAuth = async (url, options = {}) => {
  const token = localStorage.getItem('token');
  
  return fetch(url, {
    ...options,
    headers: {
      ...options.headers,
      'Authorization': `Bearer ${token}`
    }
  });
};
```

---

## âœ… Checklist d'ImplÃ©mentation

- [x] Route `/auth/login` crÃ©Ã©e
- [x] Route `/auth/me` crÃ©Ã©e
- [x] Route `/auth/refresh` crÃ©Ã©e
- [x] JWT Token generation
- [x] Token validation
- [x] Users de test configurÃ©s
- [x] Routes intÃ©grÃ©es dans api/__init__.py
- [x] Security helpers corrigÃ©s
- [x] Tests possibles

---

## ğŸ¯ Prochaines Ã‰tapes (Phase 2)

1. **CrÃ©er une vraie table User en BD** (remplacer TEST_USERS)
   ```python
   class User(BaseModel):
       id = Column(Integer, primary_key=True)
       email = Column(String(255), unique=True)
       password_hash = Column(String(255))
       is_admin = Column(Boolean, default=False)
   ```

2. **Ajouter UserService** pour CRUD Users

3. **ImplÃ©menter le register** (`POST /auth/register`)

4. **Ajouter la validation des permissions** sur les routes

5. **Frontend React** avec login/logout

---

## ğŸ’¡ Points Importants

âš ï¸ **Les mots de passe sont en dur** (dÃ©veloppement seulement)
- En production: Hasher les passwords avec `verify_password()`
- Stocker en BD

âš ï¸ **Pas de token blacklist**
- Pour une vraie logout, ajouter Redis pour blacklist les tokens

âš ï¸ **Authentification optionnelle** par dÃ©faut
- Vous pouvez commencer sans auth sur les routes
- Ajouter `Depends(get_current_user)` quand vous en avez besoin

---

## ğŸ“ Ressources

- JWT: https://jwt.io/
- FastAPI Security: https://fastapi.tiangolo.com/tutorial/security/
- python-jose: https://github.com/mpdavis/python-jose

---

## âœ¨ C'est PrÃªt!

Vous pouvez maintenant:
- âœ… Tester l'authentification dans Swagger UI
- âœ… Obtenir des tokens
- âœ… AccÃ©der aux API protÃ©gÃ©es
- âœ… GÃ©rer les erreurs d'authentification

**Prochaine Ã©tape?** Phase 2 avec Frontend React! ğŸš€