# TPM Finance CRM - Backend API

SystÃ¨me de gestion de relation client (CRM) propriÃ©taire pour TPM Finance, spÃ©cialisÃ© dans le pipeline commercial d'investisseurs/fournisseurs.

## ğŸ“‹ Architecture

### Stack Technique
- **Backend**: FastAPI (Python 3.11)
- **Database**: PostgreSQL 16
- **Containerization**: Docker & Docker Compose
- **ORM**: SQLAlchemy 2.0
- **Validation**: Pydantic v2

### Structure

```
crm-backend/
â”œâ”€â”€ core/              # Configuration, DB, exceptions, security
â”œâ”€â”€ models/            # SQLAlchemy models (Investor, Interaction, KPI)
â”œâ”€â”€ schemas/           # Pydantic schemas pour validation/rÃ©ponses
â”œâ”€â”€ services/          # Logique mÃ©tier (BaseService rÃ©utilisable)
â”œâ”€â”€ api/
â”‚   â””â”€â”€ routes/        # Routes FastAPI (investors, interactions, kpis)
â”œâ”€â”€ scripts/           # Scripts utilitaires (backup, restore)
â”œâ”€â”€ main.py            # Application FastAPI
â”œâ”€â”€ docker-compose.yml # Orchestration des services
â””â”€â”€ Dockerfile         # Image Docker de l'API
```

## ğŸš€ DÃ©marrage Rapide

### PrÃ©requis
- Docker & Docker Compose
- Ou: Python 3.11+ & PostgreSQL 16

### Option 1: Avec Docker (RecommandÃ©)

```bash
# DÃ©marrer les services
docker-compose up -d

# Voir les logs
docker-compose logs -f api

# AccÃ©der Ã  l'API
# API: http://localhost:8000
# Docs: http://localhost:8000/docs
# ReDoc: http://localhost:8000/redoc
```

### Option 2: Local (DÃ©veloppement)

```bash
# CrÃ©er un environnement virtuel
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# Installer les dÃ©pendances
pip install -r requirements.txt

# Configurer l'environnement
cp .env.example .env
# Ã‰diter .env avec vos paramÃ¨tres

# DÃ©marrer PostgreSQL
# (installer PostgreSQL ou utiliser Docker: docker run -d -p 5432:5432 postgres:16)

# DÃ©marrer l'API
python main.py
```

## ğŸ“š Architecture Ultra-Modulaire

### Philosophie Core: Zero Duplication

#### BaseService GÃ©nÃ©rique
```python
# Tous les services hÃ©ritent de BaseService
# CRUD gÃ©nÃ©riques + mÃ©thodes rÃ©utilisables

class InvestorService(BaseService[Investor, InvestorCreate, InvestorUpdate]):
    async def get_by_pipeline_stage(self, stage):
        # Logique mÃ©tier spÃ©cifique
```

#### Schemas HÃ©ritÃ©s
```python
# BaseSchema â†’ TimestampedSchema â†’ ModÃ¨les spÃ©cifiques
# Ã‰vite la redondance (timestamps, validation, config)
```

#### Routes CentralisÃ©es
```python
# api/__init__.py centralise tous les routeurs
# Une source unique de configuration
```

## ğŸ”Œ API Endpoints

### Investisseurs
```
GET    /api/v1/investors                    # Liste avec pagination
GET    /api/v1/investors/search?q=...       # Recherche
GET    /api/v1/investors/stats              # Statistiques
GET    /api/v1/investors/{id}               # DÃ©tails complets
POST   /api/v1/investors                    # CrÃ©er
PUT    /api/v1/investors/{id}               # Mettre Ã  jour
PUT    /api/v1/investors/{id}/move-to-next-stage  # Pipeline
DELETE /api/v1/investors/{id}               # Supprimer
```

### Interactions
```
GET    /api/v1/interactions                 # Liste
GET    /api/v1/interactions/investor/{id}   # Par investisseur
POST   /api/v1/interactions/investor/{id}   # CrÃ©er
PUT    /api/v1/interactions/{id}            # Mettre Ã  jour
DELETE /api/v1/interactions/{id}            # Supprimer
```

### KPIs
```
GET    /api/v1/kpis                         # Liste
GET    /api/v1/kpis/investor/{id}?year=... # Par investisseur
POST   /api/v1/kpis/investor/{id}           # CrÃ©er/Mettre Ã  jour
GET    /api/v1/kpis/summary/month/{year}/{month}  # RÃ©sumÃ© mensuel
GET    /api/v1/kpis/summary/annual/{id}/{year}    # RÃ©sumÃ© annuel
```

## ğŸ” Authentification

L'API utilise **JWT (Bearer tokens)** pour l'authentification.

```bash
# Exemple de requÃªte authentifiÃ©e
curl -H "Authorization: Bearer YOUR_TOKEN" \
     http://localhost:8000/api/v1/investors
```

**Ã€ implÃ©menter**: Endpoint de login pour gÃ©nÃ©rer les tokens

## ğŸ’¾ Base de DonnÃ©es

### ModÃ¨les Principaux

#### Investor
- `id`: Primary key
- `name`, `email`, `phone`, `website`
- `pipeline_stage`: prospect_froid â†’ client
- `client_type`: CGPI, Wholesale, Institutionnel
- `is_active`, `created_at`, `updated_at`

#### Contact
- LiÃ© Ã  un Investor
- Informations du contact direct

#### Interaction
- Type: Appel, Email, RÃ©union, Webinaire
- Date, durÃ©e, notes
- Historique complet

#### KPI
- Mensuel par investisseur
- MÃ©triques: RDV, pitchs, due diligences, closings
- Revenue tracking, commission rate

## ğŸ”„ Sauvegarde & Restauration

### Sauvegarder
```bash
# CrÃ©er une sauvegarde
docker-compose exec postgres pg_dump -U crm_user crm_db | gzip > backup.sql.gz

# Ou avec le script
./scripts/backup.sh
```

### Restaurer
```bash
# Restaurer une sauvegarde
gunzip < backup.sql.gz | docker-compose exec -T postgres psql -U crm_user -d crm_db

# Ou avec le script
./scripts/restore.sh backup.sql.gz
```

## ğŸ§ª Testing

```bash
# AccÃ©der Ã  Swagger UI interactif
# http://localhost:8000/docs

# Ou ReDoc
# http://localhost:8000/redoc
```

## ğŸ“ Variables d'Environnement

```
DATABASE_URL=postgresql://user:pass@host/db
DATABASE_ECHO=False
DEBUG=True
SECRET_KEY=your-secret-key
JWT_ALGORITHM=HS256
JWT_EXPIRATION_HOURS=24
ALLOWED_ORIGINS=http://localhost:3000,http://localhost:5173
```

## ğŸš¢ DÃ©ploiement en Production

### Sur serveur louÃ©

```bash
# 1. Cloner le projet
git clone ... crm-backend
cd crm-backend

# 2. Configurer l'environnement
cp .env.example .env
# Ã‰diter .env avec configuration production

# 3. DÃ©marrer avec Compose
docker-compose up -d

# 4. Mettre en place les backups automatiques
crontab -e
# Ajouter: 0 2 * * * /path/to/scripts/backup.sh
```

### Avec nginx (reverse proxy)

```nginx
server {
    listen 80;
    server_name crm.example.com;

    location / {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

## ğŸ“š Phase 2 (Prochaines Ã©tapes)

- [ ] SystÃ¨me de rapports automatisÃ©s (PDF/Excel)
- [ ] Import/Export Excel
- [ ] Filtres avancÃ©s et recherche full-text
- [ ] SystÃ¨me de permissions granulaires
- [ ] Webhooks pour intÃ©grations tierces
- [ ] SystÃ¨me de notifications
- [ ] Analytics et dashboards

## âœ¨ Points ClÃ©s de l'Architecture

âœ… **Modulaire**: Chaque composant est indÃ©pendant et testable
âœ… **Scalable**: BaseService + services mÃ©tier extensibles
âœ… **Maintenable**: Zero duplication, code centralisÃ©
âœ… **Type-safe**: Pydantic + SQLAlchemy
âœ… **Performant**: Async/await, pooling DB
âœ… **SÃ©curisÃ©**: JWT, validation, exception handling

## ğŸ“ Support

Pour les questions sur l'architecture ou l'implÃ©mentation, consultez:
- SQLAlchemy: https://docs.sqlalchemy.org/
- FastAPI: https://fastapi.tiangolo.com/
- Pydantic: https://docs.pydantic.dev/